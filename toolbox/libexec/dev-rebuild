#!/usr/bin/env ruby

require "shellwords"
require "fileutils"
require "pathname"

system "rbenv global system && rbenv rehash && rbenv shell --unset"

defs = `rbenv install --list`.split.select { |v| v =~ /[0-9]/ }
eol_versions = %w[
  2.6.10
  2.7.8
]
dev_versions = %w[
  3.0
  3.1
  3.2
  3.3
]

eol_versions.each do |v|
  puts "Installing #{v}"
  system "rbenv uninstall -f #{v}"
  system "env RUBY_CONFIGURE_OPTS=\"--disable-install-doc --with-libyaml-dir=$(brew --prefix libyaml) --with-gmp-dir=$(brew --prefix gmp) --with-openssl-dir=$(brew --prefix openssl@1.1)\" rbenv install -f #{v}"
end

dev_versions.each do |v|
  openssl_version = (v.to_f > 3.0) ? "3" : "1.1"
  puts "Installing #{v}"
  system "rbenv uninstall -f #{v}.0-dev"
  system "env RUBY_CONFIGURE_OPTS=\"--disable-install-doc --with-libyaml-dir=$(brew --prefix libyaml) --with-gmp-dir=$(brew --prefix gmp) --with-openssl-dir=$(brew --prefix openssl@#{openssl_version})\" rbenv install -f #{v}.0-dev"
  Dir.chdir(ENV["RBENV_ROOT"] + "/versions") do
    FileUtils.rm_rf v
    File.symlink(v + ".0-dev", v)
    d = defs.find { |d| d =~ /^#{v}.\d+$/ }
    if d
      latest = d.match(/\d+$/).to_s.to_i
      0.upto(latest) do |i|
        stable = "#{v}.#{i}"
        File.unlink(stable) if File.symlink?(stable)
        File.symlink(v + ".0-dev", stable)
      end
    end
  end
end

platforms = %w[jruby truffleruby truffleruby+graalvm]
platforms.each do |pf|
  d = defs.find { |d| d =~ Regexp.new(pf.shellescape) }
  system "rbenv uninstall -f #{d} && rbenv install #{d}"
end

system "rbenv global #{dev_versions.last}.0-dev"
