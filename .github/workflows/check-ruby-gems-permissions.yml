name: Check Ruby Gems Directory Permissions

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  check-permissions:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ['ubuntu-22.04', 'ubuntu-24.04', 'macos-15']
    
    steps:
      - name: Check Ruby installations
        run: |
          echo "=== Checking preinstalled Ruby versions ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
          fi
          ls -la "$BASE_PATH" || echo "Ruby directory not found"
          
      - name: Check Ruby 3.2.10 gems permissions
        run: |
          echo "=== Checking Ruby 3.2.10 ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
            ARCH="arm64"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
            ARCH="x64"
          fi
          RUBY_VERSION="3.2.10"
          GEM_VERSION="3.2.0"
          GEMS_PATH="${BASE_PATH}/${RUBY_VERSION}/${ARCH}/lib/ruby/gems/${GEM_VERSION}/gems"
          
          if [ -d "$GEMS_PATH" ]; then
            echo "Directory exists: $GEMS_PATH"
            echo ""
            echo "=== Directory permissions ==="
            ls -la "$GEMS_PATH" | head -20
          else
            echo "Directory not found: $GEMS_PATH"
          fi
          
      - name: Check Ruby 3.3.10 gems permissions
        run: |
          echo "=== Checking Ruby 3.3.10 ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
            ARCH="arm64"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
            ARCH="x64"
          fi
          RUBY_VERSION="3.3.10"
          GEM_VERSION="3.3.0"
          GEMS_PATH="${BASE_PATH}/${RUBY_VERSION}/${ARCH}/lib/ruby/gems/${GEM_VERSION}/gems"
          
          if [ -d "$GEMS_PATH" ]; then
            echo "Directory exists: $GEMS_PATH"
            echo ""
            echo "=== Directory permissions ==="
            ls -la "$GEMS_PATH" | head -20
          else
            echo "Directory not found: $GEMS_PATH"
          fi
          
      - name: Check Ruby 3.4.8 gems permissions
        run: |
          echo "=== Checking Ruby 3.4.8 ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
            ARCH="arm64"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
            ARCH="x64"
          fi
          RUBY_VERSION="3.4.8"
          GEM_VERSION="3.4.0"
          GEMS_PATH="${BASE_PATH}/${RUBY_VERSION}/${ARCH}/lib/ruby/gems/${GEM_VERSION}/gems"
          
          if [ -d "$GEMS_PATH" ]; then
            echo "Directory exists: $GEMS_PATH"
            echo ""
            echo "=== Directory permissions ==="
            ls -la "$GEMS_PATH" | head -20
          else
            echo "Directory not found: $GEMS_PATH"
          fi
          
      - name: Check Ruby 4.0.1 gems permissions
        run: |
          echo "=== Checking Ruby 4.0.1 ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
            ARCH="arm64"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
            ARCH="x64"
          fi
          RUBY_VERSION="4.0.1"
          GEM_VERSION="4.0.0"
          GEMS_PATH="${BASE_PATH}/${RUBY_VERSION}/${ARCH}/lib/ruby/gems/${GEM_VERSION}/gems"
          
          if [ -d "$GEMS_PATH" ]; then
            echo "Directory exists: $GEMS_PATH"
            echo ""
            echo "=== Directory permissions ==="
            ls -la "$GEMS_PATH" | head -20
          else
            echo "Directory not found: $GEMS_PATH"
          fi
          
      - name: Summary - Find all world-writable gem directories
        run: |
          echo "=== Summary: All world-writable gem directories across all Ruby versions ==="
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASE_PATH="/Users/runner/hostedtoolcache/Ruby"
            ARCH="arm64"
          else
            BASE_PATH="/opt/hostedtoolcache/Ruby"
            ARCH="x64"
          fi
          for RUBY_VERSION in 3.2.10 3.3.10 3.4.8 4.0.1; do
            case $RUBY_VERSION in
              3.2.*) GEM_VERSION="3.2.0" ;;
              3.3.*) GEM_VERSION="3.3.0" ;;
              3.4.*) GEM_VERSION="3.4.0" ;;
              4.0.*) GEM_VERSION="4.0.0" ;;
            esac
            GEMS_PATH="${BASE_PATH}/${RUBY_VERSION}/${ARCH}/lib/ruby/gems/${GEM_VERSION}/gems"
            if [ -d "$GEMS_PATH" ]; then
              echo ""
              echo "Ruby ${RUBY_VERSION}:"
              WRITABLE=$(find "$GEMS_PATH" -maxdepth 1 -type d -perm -002 2>/dev/null | wc -l)
              if [ "$WRITABLE" -gt 0 ]; then
                echo "  Found $WRITABLE world-writable directories"
                find "$GEMS_PATH" -maxdepth 1 -type d -perm -002 -exec stat -c "    %a %n" {} \;
              else
                echo "  No world-writable directories found"
              fi
            fi
          done
